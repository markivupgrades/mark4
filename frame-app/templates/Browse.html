<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Browse Photos</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #f9f9f9;
    }

    .browse-container {
      width: 100%;
      padding: 1em;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 1.5em;
      background-color: black;
      min-height: 100vh;
    }

    .browse-header-bar {
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.5em;
      padding: 0.5em 1em;
      background-color: #909090;
      border-bottom: 1px solid #ddd;
    }

.select-header {
  font-size: 3em;
  font-weight: 700;
  color: white;
  text-align: center;
  padding: 1px 24px;
  border: 1px solid #aaa;
  border-radius: 8px;
  background-color: #707070;
  margin: 40px auto 16px; /* Increased top margin */
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
}



    .browse-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .back-button {
      background: none;
      border: none;
      color: #333;
      font-weight: bold;
      font-size: 3em;
      cursor: pointer;
      padding: 0.5em 1em;
      transition: color 0.2s ease;
    }

    .back-button:hover {
      color: #007aff;
    }

.slideshow-select-group {
  display: flex;
  justify-content: flex-end;   /* aligns group to the right */
  align-items: center;
  gap: 0.5em;
  width: 100%;
}

.slideshow-select-group select {
  font-size: 2.4em;
  padding: 0.4em 1.2em;
  padding-right: 2.8em;
  border-radius: 14px;
  border: 2px solid #ccc;
  width: auto;                 /* ‚úÖ prevents full expansion */
  max-width: 13em;             /* ‚úÖ caps width */
  background-color: #0078D4;
  color: white;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 140 140' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M35 50 L70 90 L105 50' stroke='%23ffffff' stroke-width='15' fill='none'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1em center;
  background-size: 1em;
}



    .thumbnail-scroll {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5em;
      padding: 1em 0;
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
    }

    .thumbnail-scroll img {
      width: 100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }

    .thumbnail-scroll img:hover {
      transform: scale(1.05);
    }

    .thumbnail-scroll img.selected {
      outline: 20px solid #91F527;
      outline-offset: -12px;
      box-shadow: 0 0 0 8px rgba(145, 245, 39, 0.3);
      animation: pulseBorder 2s infinite ease-in-out;
    }

    @keyframes pulseBorder {
      0%   { outline-color: #91F527; }
      50%  { outline-color: #caff6c; }
      100% { outline-color: #91F527; }
    }

    .thumbnail-scroll img.delete-select {
      outline: 20px solid #ff4444;
      outline-offset: -12px;
      box-shadow: 0 0 12px rgba(255, 68, 68, 0.4);
      transform: scale(1.05);
    }

    .browse-footer-bar {
      position: sticky;
      bottom: 0;
      z-index: 1000;
      background-color: #909090;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1em;
      font-size: 2em;
    }

    .footer-default, .footer-delete {
      display: flex;
      justify-content: space-between;
      width: 100%;
      align-items: center;
    }

    .footer-delete {
      display: none;
    }

    .trash-button {
      background: none;
      border: none;
      font-size: 2em;
      cursor: pointer;
    }

.modal-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-box {
  background: white;
  padding: 2em;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  text-align: center;
  font-size: 1.4em;
}

.modal-buttons {
  margin-top: 1em;
  display: flex;
  justify-content: center;
  gap: 1em;
}


    .delete-button, .cancel-button {
      padding: 0.5em 1.5em;
      font-size: 1.6em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .delete-button {
      background-color: #ff4444;
      color: white;
    }

    .cancel-button {
      background-color: #ccc;
      color: #333;
    }

    .selected-count {
      text-align: center;
      font-size: 1.4em;
      font-weight: bold;
    }

    .thumbnail-scroll img.drag-hover {
      outline: 4px dashed #606060;
      outline-offset: -4px;
    }

  </style>
</head>
<body>
  <div class="browse-container">
    <div class="browse-header-bar">
      <h1 class="select-header">üñºÔ∏è Select a Photo or Slideshow</h1>
      <div class="browse-controls">
        <button class="back-button" onclick="goBack()">‚Üê Back</button>
        <div class="slideshow-select-group">
          <select id="slideshow-select" onchange="handleFolderChange()">
            <option value="" disabled selected hidden>Choose Slideshow</option>
          </select>

        </div>
      </div>
    </div>

    <div class="thumbnail-scroll" id="thumbnail-scroll"></div>

    <div class="browse-footer-bar" id="browse-footer">
      <div class="footer-default" id="footer-default">
        <div class="photo-count" id="photo-count">0 Photos</div>

        <div class="sort-group" style="display: flex; align-items: center; gap: 0.5em;">
          <label for="sort-select" style="font-size: 1em;">Sort By:</label>
          <select id="sort-select" onchange="handleSort()" style="font-size: 1em; padding: 0.3em 0.8em; border-radius: 6px; border: 1px solid #ccc;">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="az">A‚ÄìZ</option>
          <option value="za">Z‚ÄìA</option>
     </select>

        </div>

        <button id="enter-delete" class="trash-button">üóëÔ∏è</button>
      </div>

      <div class="footer-delete" id="footer-delete">
        <button id="confirm-delete" class="delete-button" disabled>Delete</button>
        <div class="selected-count">
          <div id="delete-count">0</div>
          <div>Selected</div>
        </div>
        <button id="exit-delete" class="cancel-button">Cancel</button>
      </div>
    </div>

<div id="deleteModal" style="display: none;" class="modal-overlay">
  <div class="modal-box">
    <p style="margin: 0; font-weight: bold;">Delete Photos</p>
    <p id="deleteModalText" style="margin: 0;">Are you sure?</p>
    <div class="modal-buttons">
      <button class="delete-button" onclick="confirmDelete()">üóëÔ∏è Delete</button>
      <button class="cancel-button" onclick="cancelDelete()">Cancel</button>
    </div>
  </div>
</div>


<script>

let currentFolder = '';
let dragEnabled = true;
let fullImageList = [];


  function goBack() {
    window.history.back();
  }

  function viewSelected() {
    const selected = document.getElementById('slideshow-select').value;
    window.location.href = `/view?slideshow=${selected}`;
  }

let currentSort = 'newest';

  let page = 1;
  let loading = false;
  let deleteMode = false;
  let selectedForDelete = new Set();

  function handleSort() {
    const sortKey = document.getElementById('sort-select').value;
    currentSort = sortKey;
    page = 1;
    document.getElementById('thumbnail-scroll').innerHTML = '';
    loadThumbnails(currentSort);
   }

function handleFolderChange() {
  const selected = document.getElementById('slideshow-select').value;
  dragEnabled = (selected !== 'main');

  // ‚úÖ Rebuild sort dropdown
  const sortSelect = document.getElementById('sort-select');
  sortSelect.innerHTML = '';

  const options = [
    { value: 'newest', label: 'Newest' },
    { value: 'oldest', label: 'Oldest' },
    { value: 'az', label: 'A‚ÄìZ' },
    { value: 'za', label: 'Z‚ÄìA' }
  ];

  if (selected !== 'main') {
    options.unshift({ value: 'custom', label: 'Custom' });
  }

  options.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt.value;
    option.textContent = opt.label;
    sortSelect.appendChild(option);
  });

  // ‚úÖ Set default sort
  sortSelect.value = (selected === 'main') ? 'newest' : 'custom';
  currentSort = sortSelect.value;

  fetch('/select_folder', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `folder=${encodeURIComponent(selected)}`
  }).then(() => {
    page = 1;
    selectedForDelete.clear();
    document.getElementById('thumbnail-scroll').innerHTML = '';
    loadThumbnails(currentSort);
  });
}


function loadThumbnails(sort = 'newest') {
  if (loading) return;
  loading = true;

  fetch(`/api/thumbnails?page=${page}&sort=${sort}`)
    .then(res => res.json())
    .then(data => {
      currentFolder = data.folder;

      const container = document.getElementById('thumbnail-scroll');
      document.getElementById('photo-count').textContent = `${data.total} Photos`;

      // ‚úÖ Track full image list across pages
      if (page === 1) {
        fullImageList = data.images;
      } else {
        fullImageList = fullImageList.concat(data.images);
      }

      data.images.forEach(filename => {
        const img = document.createElement('img');
        img.src = `/thumbs/${data.folder}/${filename}?v=${Date.now()}`;
        img.alt = filename;
        img.setAttribute('data-filename', filename);

        const isMain = data.folder === 'main';
        img.draggable = !isMain;

        if (!isMain) {
          img.addEventListener('dragstart', e => {
            draggedImg = img;
            e.dataTransfer.effectAllowed = 'move';

            const clone = img.cloneNode(true);
            clone.style.opacity = '0.4';
            clone.style.filter = 'brightness(1.4) drop-shadow(0 0 6px rgba(0,0,0,0.2))';
            clone.style.position = 'absolute';
            clone.style.top = '-1000px';
            clone.style.pointerEvents = 'none';
            clone.style.zIndex = '9999';
            clone.style.width = img.offsetWidth + 'px';
            clone.style.height = img.offsetHeight + 'px';
            document.body.appendChild(clone);
            e.dataTransfer.setDragImage(clone, clone.width / 2, clone.height / 2);

            img.addEventListener('dragend', () => {
              document.body.removeChild(clone);
            }, { once: true });
          });

          img.addEventListener('dragover', e => {
            e.preventDefault();
          });

          img.addEventListener('drop', e => {
            e.preventDefault();
            if (draggedImg && draggedImg !== img) {
              const container = img.parentNode;
              container.insertBefore(draggedImg, img.nextSibling);

              // ‚úÖ Debounced save trigger after DOM update
              if (window.saveTimer) clearTimeout(window.saveTimer);

              window.saveTimer = setTimeout(() => {
                const domOrder = Array.from(document.querySelectorAll('.thumbnail-scroll img'))
                  .map(img => img.getAttribute('data-filename'));

                const untouched = fullImageList.filter(f => !domOrder.includes(f));
                const orderedFilenames = domOrder.concat(untouched);

                console.log('Saving order:', orderedFilenames);
                fetch('/save-custom-order', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    folder: currentFolder,
                    order: orderedFilenames
                  })
                }).then(res => {
                  if (res.ok) {
                    console.log('Custom order saved');
                  } else {
                    console.error('Failed to save custom order');
                  }
                });
              }, 2000);
            }
            img.classList.remove('drag-hover');
          });

          img.addEventListener('dragenter', () => img.classList.add('drag-hover'));
          img.addEventListener('dragleave', () => img.classList.remove('drag-hover'));
        }

        img.onclick = () => {
          if (deleteMode) {
            if (selectedForDelete.has(filename)) {
              selectedForDelete.delete(filename);
            } else {
              selectedForDelete.add(filename);
            }
            updateDeleteUI();
          } else {
            document.querySelectorAll('.thumbnail-scroll img').forEach(el => {
              el.classList.remove('selected');
            });
            img.classList.add('selected');

            fetch('/show', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: `path=${encodeURIComponent(filename)}`
            }).then(res => {
              if (res.ok) {
                console.log(`Displayed: ${filename}`);
              } else {
                console.error('Failed to display image');
              }
            });
          }
        };

        container.appendChild(img);
      });

      page++;
      loading = false;
    })
    .catch(err => {
      console.error("Error loading thumbnails:", err);
      loading = false;
    });
}

let draggedImg = null;

document.querySelectorAll('.thumbnail-scroll img').forEach(img => {
  img.addEventListener('dragstart', e => {
    draggedImg = img;
    e.dataTransfer.effectAllowed = 'move';
  });

  img.addEventListener('dragover', e => {
    e.preventDefault(); // Required to allow drop
  });

  img.addEventListener('drop', e => {
    e.preventDefault();
    if (draggedImg && draggedImg !== img) {
      const container = img.parentNode;
      container.insertBefore(draggedImg, img.nextSibling);
    }
  });

  img.addEventListener('dragenter', () => img.classList.add('drag-hover'));
  img.addEventListener('dragleave', () => img.classList.remove('drag-hover'));
  img.addEventListener('drop', () => img.classList.remove('drag-hover'));
});


function confirmDelete() {
  const deletePromises = Array.from(selectedForDelete).map(filename => {
    return fetch('/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `path=${encodeURIComponent(filename)}`
    });
  });

  Promise.all(deletePromises).then(() => {
    selectedForDelete.clear();
    document.getElementById('footer-default').style.display = 'flex';
    document.getElementById('footer-delete').style.display = 'none';
    document.getElementById('deleteModal').style.display = 'none';
    deleteMode = false;
    updateDeleteUI();
    location.reload();
  });
}


function cancelDelete() {
  document.getElementById('deleteModal').style.display = 'none';
}



function updateDeleteUI() {
  document.getElementById('delete-count').textContent = selectedForDelete.size;
  document.getElementById('confirm-delete').disabled = selectedForDelete.size === 0;

  document.querySelectorAll('.thumbnail-scroll img').forEach(img => {
    img.classList.remove('delete-select');

    if (selectedForDelete.has(img.alt)) {
      img.classList.add('delete-select');
      img.classList.remove('selected'); // ‚úÖ Remove green if red is active
    }
  });
}

  document.getElementById('enter-delete').onclick = () => {
    deleteMode = true;
    selectedForDelete.clear();
    document.getElementById('footer-default').style.display = 'none';
    document.getElementById('footer-delete').style.display = 'flex';
    updateDeleteUI();
  };

  document.getElementById('exit-delete').onclick = () => {
    deleteMode = false;
    selectedForDelete.clear();
    document.getElementById('footer-default').style.display = 'flex';
    document.getElementById('footer-delete').style.display = 'none';
    updateDeleteUI();
  };

  document.getElementById('confirm-delete').onclick = () => {
  if (selectedForDelete.size === 0) return;

  document.getElementById('deleteModalText').textContent =
    `Delete ${selectedForDelete.size} items? This cannot be undone.`;

  document.getElementById('deleteModal').style.display = 'flex';
};


window.addEventListener('DOMContentLoaded', () => {
  Promise.all([
    fetch('/list-slideshows').then(res => res.json()),
    fetch('/config').then(res => res.json())
  ]).then(([folders, config]) => {
    const select = document.getElementById('slideshow-select');
    const sortSelect = document.getElementById('sort-select');
    const current = config.current_folder;

    // ‚úÖ Populate slideshow dropdown
    folders.forEach(name => {
      const friendlyName = name.replace(/_/g, ' ').replace(/\w\S*/g, word =>
        word.charAt(0).toUpperCase() + word.substring(1).toLowerCase()
      );
      const option = document.createElement('option');
      option.value = name;
      option.textContent = friendlyName;
      select.appendChild(option);
    });

    if (current) {
      select.value = current;
    }

    // ‚úÖ Rebuild sort dropdown based on current folder
    sortSelect.innerHTML = '';

    const options = [
      { value: 'newest', label: 'Newest' },
      { value: 'oldest', label: 'Oldest' },
      { value: 'az', label: 'A‚ÄìZ' },
      { value: 'za', label: 'Z‚ÄìA' }
    ];

    if (current !== 'main') {
      options.unshift({ value: 'custom', label: 'Custom' });
    }

    options.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt.value;
      option.textContent = opt.label;
      sortSelect.appendChild(option);
    });

    // ‚úÖ Set default sort
    sortSelect.value = (current === 'main') ? 'newest' : 'custom';
    currentSort = sortSelect.value;

    select.addEventListener('change', handleFolderChange);
    loadThumbnails(currentSort);  // ‚úÖ This is now the only call
  });
});

window.addEventListener('scroll', () => {
  const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 100;
  if (nearBottom) {
    const sortBy = document.getElementById('sort-select')?.value || 'newest';
    loadThumbnails(sortBy);
  }
});
</script>
</body>
</html>
